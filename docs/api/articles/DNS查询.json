{"title":"rust DNS 查询实现","uid":"0aecaa233b1916984a65c4a9a27b4910","slug":"DNS查询","date":"2024-12-17T13:38:28.000Z","updated":"2025-03-30T13:19:30.886Z","comments":true,"path":"api/articles/DNS查询.json","keywords":null,"cover":null,"content":"<h1 id=\"代码\"><a href=\"#代码\" class=\"headerlink\" title=\"代码\"></a>代码</h1><figure class=\"highlight rust\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">use</span> std::net::&#123;Ipv4Addr, UdpSocket&#125;;</span><br><span class=\"line\"><span class=\"keyword\">use</span> std::time::Duration;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// DNS 响应码</span></span><br><span class=\"line\"><span class=\"keyword\">enum</span> <span class=\"title class_\">ResponseCode</span> &#123;</span><br><span class=\"line\">    NoError = <span class=\"number\">0</span>,</span><br><span class=\"line\">    FormatError = <span class=\"number\">1</span>,</span><br><span class=\"line\">    ServerFailure = <span class=\"number\">2</span>,</span><br><span class=\"line\">    NameEroor = <span class=\"number\">3</span>,</span><br><span class=\"line\">    NotImplemented = <span class=\"number\">4</span>,</span><br><span class=\"line\">    Refused = <span class=\"number\">5</span>,</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 创建随机查询 ID</span></span><br><span class=\"line\"><span class=\"keyword\">fn</span> <span class=\"title function_\">random_id</span>() <span class=\"punctuation\">-&gt;</span> <span class=\"type\">u16</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">use</span> std::time::&#123;SystemTime, UNIX_EPOCH&#125;;</span><br><span class=\"line\">    <span class=\"keyword\">let</span> <span class=\"variable\">now</span> = SystemTime::<span class=\"title function_ invoke__\">now</span>().<span class=\"title function_ invoke__\">duration_since</span>(UNIX_EPOCH).<span class=\"title function_ invoke__\">unwrap</span>();</span><br><span class=\"line\">    (now.<span class=\"title function_ invoke__\">as_secs</span>() <span class=\"keyword\">as</span> <span class=\"type\">u16</span>) ^ (now.<span class=\"title function_ invoke__\">subsec_nanos</span>() <span class=\"keyword\">as</span> <span class=\"type\">u16</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 构建DNS查询包</span></span><br><span class=\"line\"><span class=\"keyword\">fn</span> <span class=\"title function_\">build_query</span>(domain: &amp;<span class=\"type\">str</span>, id: <span class=\"type\">u16</span>) <span class=\"punctuation\">-&gt;</span> <span class=\"type\">Vec</span>&lt;<span class=\"type\">u8</span>&gt; &#123;</span><br><span class=\"line\">    <span class=\"keyword\">let</span> <span class=\"keyword\">mut </span><span class=\"variable\">query</span> = <span class=\"type\">Vec</span>::<span class=\"title function_ invoke__\">new</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 头部</span></span><br><span class=\"line\">    query.<span class=\"title function_ invoke__\">extend_from_slice</span>(&amp;id.<span class=\"title function_ invoke__\">to_be_bytes</span>()); <span class=\"comment\">// ID</span></span><br><span class=\"line\">    query.<span class=\"title function_ invoke__\">extend_from_slice</span>(&amp;[<span class=\"number\">0x01</span>, <span class=\"number\">0x00</span>]); <span class=\"comment\">// 标志：标准查询，递归期望</span></span><br><span class=\"line\">    query.<span class=\"title function_ invoke__\">extend_from_slice</span>(&amp;[<span class=\"number\">0x00</span>, <span class=\"number\">0x01</span>]); <span class=\"comment\">// 问题数量：1</span></span><br><span class=\"line\">    query.<span class=\"title function_ invoke__\">extend_from_slice</span>(&amp;[<span class=\"number\">0x00</span>, <span class=\"number\">0x00</span>]); <span class=\"comment\">// 回答数量：0</span></span><br><span class=\"line\">    query.<span class=\"title function_ invoke__\">extend_from_slice</span>(&amp;[<span class=\"number\">0x00</span>, <span class=\"number\">0x00</span>]); <span class=\"comment\">// 权威回答数量：0</span></span><br><span class=\"line\">    query.<span class=\"title function_ invoke__\">extend_from_slice</span>(&amp;[<span class=\"number\">0x00</span>, <span class=\"number\">0x00</span>]); <span class=\"comment\">// 附加记录数量：0</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 问题部分 - 域名</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> <span class=\"variable\">part</span> <span class=\"keyword\">in</span> domain.<span class=\"title function_ invoke__\">split</span>(<span class=\"string\">&#x27;.&#x27;</span>) &#123;</span><br><span class=\"line\">        query.<span class=\"title function_ invoke__\">push</span>(part.<span class=\"title function_ invoke__\">len</span>() <span class=\"keyword\">as</span> <span class=\"type\">u8</span>);</span><br><span class=\"line\">        query.<span class=\"title function_ invoke__\">extend_from_slice</span>(part.<span class=\"title function_ invoke__\">as_bytes</span>());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    query.<span class=\"title function_ invoke__\">push</span>(<span class=\"number\">0x00</span>); <span class=\"comment\">// 域名结束标记</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 问题部分 - 查询类型和类</span></span><br><span class=\"line\">    query.<span class=\"title function_ invoke__\">extend_from_slice</span>(&amp;[<span class=\"number\">0x00</span>, <span class=\"number\">0x01</span>]); <span class=\"comment\">// 类型：A记录</span></span><br><span class=\"line\">    query.<span class=\"title function_ invoke__\">extend_from_slice</span>(&amp;[<span class=\"number\">0x00</span>, <span class=\"number\">0x01</span>]); <span class=\"comment\">// 类：IN (Internet)</span></span><br><span class=\"line\"></span><br><span class=\"line\">    query</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 解析DNS响应</span></span><br><span class=\"line\"><span class=\"keyword\">fn</span> <span class=\"title function_\">parse_response</span>(response: &amp;[<span class=\"type\">u8</span>], expected_id: <span class=\"type\">u16</span>) <span class=\"punctuation\">-&gt;</span> <span class=\"type\">Result</span>&lt;<span class=\"type\">Vec</span>&lt;Ipv4Addr&gt;, <span class=\"type\">String</span>&gt; &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> response.<span class=\"title function_ invoke__\">len</span>() &lt; <span class=\"number\">12</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"title function_ invoke__\">Err</span>(<span class=\"string\">&quot;响应太短&quot;</span>.<span class=\"title function_ invoke__\">to_string</span>());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 解析ID</span></span><br><span class=\"line\">    <span class=\"keyword\">let</span> <span class=\"variable\">id</span> = <span class=\"type\">u16</span>::<span class=\"title function_ invoke__\">from_be_bytes</span>([response[<span class=\"number\">0</span>], response[<span class=\"number\">1</span>]]);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> id != expected_id &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"title function_ invoke__\">Err</span>(<span class=\"built_in\">format!</span>(<span class=\"string\">&quot;ID不匹配：期望 &#123;&#125;, 收到 &#123;&#125;&quot;</span>, expected_id, id));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 解析标志</span></span><br><span class=\"line\">    <span class=\"keyword\">let</span> <span class=\"variable\">flags</span> = <span class=\"type\">u16</span>::<span class=\"title function_ invoke__\">from_be_bytes</span>([response[<span class=\"number\">2</span>], response[<span class=\"number\">3</span>]]);</span><br><span class=\"line\">    <span class=\"keyword\">let</span> <span class=\"variable\">qr</span> = (flags &gt;&gt; <span class=\"number\">15</span>) &amp; <span class=\"number\">0x1</span>; <span class=\"comment\">// 响应位</span></span><br><span class=\"line\">    <span class=\"keyword\">let</span> <span class=\"variable\">opcode</span> = (flags &gt;&gt; <span class=\"number\">11</span>) &amp; <span class=\"number\">0xF</span>; <span class=\"comment\">// 操作码</span></span><br><span class=\"line\">    <span class=\"keyword\">let</span> <span class=\"variable\">rcode</span> = flags &amp; <span class=\"number\">0xF</span>; <span class=\"comment\">// 响应码</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> qr != <span class=\"number\">1</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"title function_ invoke__\">Err</span>(<span class=\"string\">&quot;不是响应包&quot;</span>.<span class=\"title function_ invoke__\">to_string</span>());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> opcode != <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"title function_ invoke__\">Err</span>(<span class=\"built_in\">format!</span>(<span class=\"string\">&quot;未知操作码: &#123;&#125;&quot;</span>, opcode));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">match</span> rcode &#123;</span><br><span class=\"line\">        <span class=\"number\">0</span> =&gt; &#123;&#125; <span class=\"comment\">// 没有错误</span></span><br><span class=\"line\">        <span class=\"number\">1</span> =&gt; <span class=\"keyword\">return</span> <span class=\"title function_ invoke__\">Err</span>(<span class=\"string\">&quot;DNS格式错误&quot;</span>.<span class=\"title function_ invoke__\">to_string</span>()),</span><br><span class=\"line\">        <span class=\"number\">2</span> =&gt; <span class=\"keyword\">return</span> <span class=\"title function_ invoke__\">Err</span>(<span class=\"string\">&quot;DNS服务器失败&quot;</span>.<span class=\"title function_ invoke__\">to_string</span>()),</span><br><span class=\"line\">        <span class=\"number\">3</span> =&gt; <span class=\"keyword\">return</span> <span class=\"title function_ invoke__\">Err</span>(<span class=\"string\">&quot;域名不存在&quot;</span>.<span class=\"title function_ invoke__\">to_string</span>()),</span><br><span class=\"line\">        <span class=\"number\">4</span> =&gt; <span class=\"keyword\">return</span> <span class=\"title function_ invoke__\">Err</span>(<span class=\"string\">&quot;DNS服务器不支持请求类型&quot;</span>.<span class=\"title function_ invoke__\">to_string</span>()),</span><br><span class=\"line\">        <span class=\"number\">5</span> =&gt; <span class=\"keyword\">return</span> <span class=\"title function_ invoke__\">Err</span>(<span class=\"string\">&quot;DNS查询被拒绝&quot;</span>.<span class=\"title function_ invoke__\">to_string</span>()),</span><br><span class=\"line\">        _ =&gt; <span class=\"keyword\">return</span> <span class=\"title function_ invoke__\">Err</span>(<span class=\"built_in\">format!</span>(<span class=\"string\">&quot;未知DNS错误码: &#123;&#125;&quot;</span>, rcode)),</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 获取问题和回答数量</span></span><br><span class=\"line\">    <span class=\"keyword\">let</span> <span class=\"variable\">qdcount</span> = <span class=\"type\">u16</span>::<span class=\"title function_ invoke__\">from_be_bytes</span>([response[<span class=\"number\">4</span>], response[<span class=\"number\">5</span>]]);</span><br><span class=\"line\">    <span class=\"keyword\">let</span> <span class=\"variable\">ancount</span> = <span class=\"type\">u16</span>::<span class=\"title function_ invoke__\">from_be_bytes</span>([response[<span class=\"number\">6</span>], response[<span class=\"number\">7</span>]]);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ancount == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"title function_ invoke__\">Err</span>(<span class=\"string\">&quot;没有找到任何答案&quot;</span>.<span class=\"title function_ invoke__\">to_string</span>());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 跳过问题部分</span></span><br><span class=\"line\">    <span class=\"keyword\">let</span> <span class=\"keyword\">mut </span><span class=\"variable\">pos</span> = <span class=\"number\">12</span>;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> <span class=\"variable\">_</span> <span class=\"keyword\">in</span> <span class=\"number\">0</span>..qdcount &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 跳过域名</span></span><br><span class=\"line\">        <span class=\"keyword\">while</span> pos &lt; response.<span class=\"title function_ invoke__\">len</span>() &#123;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> <span class=\"variable\">len</span> = response[pos] <span class=\"keyword\">as</span> <span class=\"type\">usize</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> len == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">                pos += <span class=\"number\">1</span>;</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// 检查是否是压缩指针</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (len &amp; <span class=\"number\">0xC0</span>) == <span class=\"number\">0xC0</span> &#123;</span><br><span class=\"line\">                pos += <span class=\"number\">2</span>;</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            pos += len + <span class=\"number\">1</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 跳过类型和类</span></span><br><span class=\"line\">        pos += <span class=\"number\">4</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 解析回答部分</span></span><br><span class=\"line\">    <span class=\"keyword\">let</span> <span class=\"keyword\">mut </span><span class=\"variable\">ips</span> = <span class=\"type\">Vec</span>::<span class=\"title function_ invoke__\">new</span>();</span><br><span class=\"line\">    <span class=\"keyword\">for</span> <span class=\"variable\">_</span> <span class=\"keyword\">in</span> <span class=\"number\">0</span>..ancount &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 跳过域名（可能是压缩指针）</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (response[pos] &amp; <span class=\"number\">0xC0</span>) == <span class=\"number\">0xC0</span> &#123;</span><br><span class=\"line\">            pos += <span class=\"number\">2</span>;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">while</span> pos &lt; response.<span class=\"title function_ invoke__\">len</span>() &#123;</span><br><span class=\"line\">                <span class=\"keyword\">let</span> <span class=\"variable\">len</span> = response[pos] <span class=\"keyword\">as</span> <span class=\"type\">usize</span>;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> len == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">                    pos += <span class=\"number\">1</span>;</span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                pos += len + <span class=\"number\">1</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 读取记录类型</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> pos + <span class=\"number\">10</span> &gt; response.<span class=\"title function_ invoke__\">len</span>() &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"title function_ invoke__\">Err</span>(<span class=\"string\">&quot;响应数据不完整&quot;</span>.<span class=\"title function_ invoke__\">to_string</span>());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">let</span> <span class=\"variable\">rec_type</span> = <span class=\"type\">u16</span>::<span class=\"title function_ invoke__\">from_be_bytes</span>([response[pos], response[pos + <span class=\"number\">1</span>]]);</span><br><span class=\"line\">        <span class=\"keyword\">let</span> <span class=\"variable\">data_len</span> = <span class=\"type\">u16</span>::<span class=\"title function_ invoke__\">from_be_bytes</span>([response[pos + <span class=\"number\">8</span>], response[pos + <span class=\"number\">9</span>]]) <span class=\"keyword\">as</span> <span class=\"type\">usize</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        pos += <span class=\"number\">10</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 检查是否是A记录</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> rec_type == <span class=\"number\">1</span> &amp;&amp; data_len == <span class=\"number\">4</span> &amp;&amp; pos + <span class=\"number\">4</span> &lt;= response.<span class=\"title function_ invoke__\">len</span>() &#123;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> <span class=\"variable\">ip</span> = Ipv4Addr::<span class=\"title function_ invoke__\">new</span>(</span><br><span class=\"line\">                response[pos],</span><br><span class=\"line\">                response[pos + <span class=\"number\">1</span>],</span><br><span class=\"line\">                response[pos + <span class=\"number\">2</span>],</span><br><span class=\"line\">                response[pos + <span class=\"number\">3</span>],</span><br><span class=\"line\">            );</span><br><span class=\"line\">            ips.<span class=\"title function_ invoke__\">push</span>(ip);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        pos += data_len;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ips.<span class=\"title function_ invoke__\">is_empty</span>() &#123;</span><br><span class=\"line\">        <span class=\"title function_ invoke__\">Err</span>(<span class=\"string\">&quot;未找到IPv4地址&quot;</span>.<span class=\"title function_ invoke__\">to_string</span>())</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"title function_ invoke__\">Ok</span>(ips)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">pub</span> <span class=\"keyword\">fn</span> <span class=\"title function_\">resolve_domain</span>(domain: &amp;<span class=\"type\">str</span>) <span class=\"punctuation\">-&gt;</span> <span class=\"type\">Result</span>&lt;<span class=\"type\">Vec</span>&lt;Ipv4Addr&gt;, <span class=\"type\">String</span>&gt; &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 创建UDP套接字</span></span><br><span class=\"line\">    <span class=\"keyword\">let</span> <span class=\"variable\">socket</span> = <span class=\"keyword\">match</span> UdpSocket::<span class=\"title function_ invoke__\">bind</span>(<span class=\"string\">&quot;0.0.0.0:0&quot;</span>) &#123;</span><br><span class=\"line\">        <span class=\"title function_ invoke__\">Ok</span>(s) =&gt; s,</span><br><span class=\"line\">        <span class=\"title function_ invoke__\">Err</span>(e) =&gt; <span class=\"keyword\">return</span> <span class=\"title function_ invoke__\">Err</span>(<span class=\"built_in\">format!</span>(<span class=\"string\">&quot;绑定套接字失败: &#123;&#125;&quot;</span>, e)),</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 设置超时</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"keyword\">let</span> <span class=\"variable\">Err</span>(e) = socket.<span class=\"title function_ invoke__\">set_read_timeout</span>(<span class=\"title function_ invoke__\">Some</span>(Duration::<span class=\"title function_ invoke__\">from_secs</span>(<span class=\"number\">5</span>))) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"title function_ invoke__\">Err</span>(<span class=\"built_in\">format!</span>(<span class=\"string\">&quot;设置超时失败: &#123;&#125;&quot;</span>, e));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 连接到DNS服务器</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"keyword\">let</span> <span class=\"variable\">Err</span>(e) = socket.<span class=\"title function_ invoke__\">connect</span>(<span class=\"string\">&quot;8.8.8.8:53&quot;</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"title function_ invoke__\">Err</span>(<span class=\"built_in\">format!</span>(<span class=\"string\">&quot;连接DNS服务器失败: &#123;&#125;&quot;</span>, e));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 生成随机ID</span></span><br><span class=\"line\">    <span class=\"keyword\">let</span> <span class=\"variable\">query_id</span> = <span class=\"title function_ invoke__\">random_id</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 构建DNS查询</span></span><br><span class=\"line\">    <span class=\"keyword\">let</span> <span class=\"variable\">query</span> = <span class=\"title function_ invoke__\">build_query</span>(domain, query_id);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 发送查询</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"keyword\">let</span> <span class=\"variable\">Err</span>(e) = socket.<span class=\"title function_ invoke__\">send</span>(&amp;query) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"title function_ invoke__\">Err</span>(<span class=\"built_in\">format!</span>(<span class=\"string\">&quot;发送查询失败: &#123;&#125;&quot;</span>, e));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 接收响应</span></span><br><span class=\"line\">    <span class=\"keyword\">let</span> <span class=\"keyword\">mut </span><span class=\"variable\">buf</span> = [<span class=\"number\">0u8</span>; <span class=\"number\">512</span>];</span><br><span class=\"line\">    <span class=\"keyword\">let</span> <span class=\"variable\">size</span> = <span class=\"keyword\">match</span> socket.<span class=\"title function_ invoke__\">recv</span>(&amp;<span class=\"keyword\">mut</span> buf) &#123;</span><br><span class=\"line\">        <span class=\"title function_ invoke__\">Ok</span>(n) =&gt; n,</span><br><span class=\"line\">        <span class=\"title function_ invoke__\">Err</span>(e) =&gt; <span class=\"keyword\">return</span> <span class=\"title function_ invoke__\">Err</span>(<span class=\"built_in\">format!</span>(<span class=\"string\">&quot;接收响应失败: &#123;&#125;&quot;</span>, e)),</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 解析响应</span></span><br><span class=\"line\">    <span class=\"title function_ invoke__\">parse_response</span>(&amp;buf[<span class=\"number\">0</span>..size], query_id)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#[cfg(test)]</span></span><br><span class=\"line\"><span class=\"keyword\">mod</span> tests &#123;</span><br><span class=\"line\">    <span class=\"keyword\">use</span> super::*;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">#[test]</span></span><br><span class=\"line\">    <span class=\"keyword\">fn</span> <span class=\"title function_\">test_reslove_domain</span>() &#123;</span><br><span class=\"line\">        <span class=\"built_in\">println!</span>(<span class=\"string\">&quot;baidu.com:&#123;:#?&#125;&quot;</span>, <span class=\"title function_ invoke__\">resolve_domain</span>(<span class=\"string\">&quot;baidu.com&quot;</span>).<span class=\"title function_ invoke__\">unwrap</span>());</span><br><span class=\"line\">        <span class=\"built_in\">println!</span>(</span><br><span class=\"line\">            <span class=\"string\">&quot;fengliuhuo.top: &#123;:#?&#125;&quot;</span>,</span><br><span class=\"line\">            <span class=\"title function_ invoke__\">resolve_domain</span>(<span class=\"string\">&quot;barn.fengliuhuo.top&quot;</span>).<span class=\"title function_ invoke__\">unwrap</span>()</span><br><span class=\"line\">        );</span><br><span class=\"line\">        <span class=\"built_in\">println!</span>(<span class=\"string\">&quot;myhome.org: &#123;:#?&#125;&quot;</span>, <span class=\"title function_ invoke__\">resolve_domain</span>(<span class=\"string\">&quot;myhome.org&quot;</span>).<span class=\"title function_ invoke__\">unwrap</span>());</span><br><span class=\"line\">        <span class=\"built_in\">println!</span>(</span><br><span class=\"line\">            <span class=\"string\">&quot;fengliuhuo.top: &#123;:#?&#125;&quot;</span>,</span><br><span class=\"line\">            <span class=\"title function_ invoke__\">resolve_domain</span>(<span class=\"string\">&quot;fengliuhuo.top&quot;</span>).<span class=\"title function_ invoke__\">unwrap</span>()</span><br><span class=\"line\">        );</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>","feature":true,"text":"代码123456789101112131415161718192021222324252627282930313233343536373839404142434...","permalink":"/post/DNS查询","photos":[],"count_time":{"symbolsCount":"6.8k","symbolsTime":"6 mins."},"categories":[{"name":"rust","slug":"rust","count":2,"path":"api/categories/rust.json"}],"tags":[{"name":"DNS","slug":"DNS","count":1,"path":"api/tags/DNS.json"},{"name":"rust","slug":"rust","count":2,"path":"api/tags/rust.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E4%BB%A3%E7%A0%81\"><span class=\"toc-text\">代码</span></a></li></ol>","author":{"name":"liuhuo","slug":"blog-author","avatar":"https://avatars.githubusercontent.com/u/45648682?s=400&u=9abf5def111f37821c3d6e638dff306f7d4aa94c&v=4","link":"/","description":"无生有涯，学习无崖","socials":{"github":"https://github.com/liuhuo23","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"hidden":false,"prev_post":{"title":"rust安装","uid":"6904b6e2cd4631c9cbc3edadb24f9469","slug":"rust安装","date":"2024-12-17T13:38:28.000Z","updated":"2024-12-20T17:04:05.049Z","comments":true,"path":"api/articles/rust安装.json","keywords":null,"cover":null,"text":"Rust 安装","permalink":"/post/rust安装","photos":[],"count_time":{"symbolsCount":7,"symbolsTime":"1 mins."},"categories":[{"name":"rust","slug":"rust","count":2,"path":"api/categories/rust.json"}],"tags":[{"name":"rust","slug":"rust","count":2,"path":"api/tags/rust.json"},{"name":"安装","slug":"安装","count":2,"path":"api/tags/安装.json"}],"author":{"name":"liuhuo","slug":"blog-author","avatar":"https://avatars.githubusercontent.com/u/45648682?s=400&u=9abf5def111f37821c3d6e638dff306f7d4aa94c&v=4","link":"/","description":"无生有涯，学习无崖","socials":{"github":"https://github.com/liuhuo23","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"feature":true},"next_post":{"title":"python 安装","uid":"d723e70f8e4e44340d60bd293f961327","slug":"python","date":"2024-12-17T12:47:39.000Z","updated":"2024-12-17T13:25:53.869Z","comments":true,"path":"api/articles/python.json","keywords":null,"cover":null,"text":"Python如何安装一个python ","permalink":"/post/python","photos":[],"count_time":{"symbolsCount":19,"symbolsTime":"1 mins."},"categories":[{"name":"Python","slug":"Python","count":1,"path":"api/categories/Python.json"}],"tags":[{"name":"安装","slug":"安装","count":2,"path":"api/tags/安装.json"}],"author":{"name":"liuhuo","slug":"blog-author","avatar":"https://avatars.githubusercontent.com/u/45648682?s=400&u=9abf5def111f37821c3d6e638dff306f7d4aa94c&v=4","link":"/","description":"无生有涯，学习无崖","socials":{"github":"https://github.com/liuhuo23","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}